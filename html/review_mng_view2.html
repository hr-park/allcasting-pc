<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>All CASTING</title>
	<link rel="stylesheet" href="../static/css/NotoSansKR.css">
	<link rel="stylesheet" href="../static/css/style.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
	<script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="../static/js/common.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
	<div class="wrap">
		<header class="header">
			<div class="inner">
				<div class="logo_wrap">
					<h1 class="logo"><img src="../static/images/logo.png" alt="ALLCASTING"></h1>
					<!-- Caster GNB -->
					<nav class="gnb">
						<button type="button" class="link" onclick="location.href='index_caster.html'">홈</button>
						<button type="button" class="link" onclick="location.href='project_list.html'">내 프로젝트</button>
						<button type="button" class="link active" onclick="location.href='review_mng_list.html'">심사 관리</button>
						<button type="button" class="link" onclick="location.href='schedule_caster.html'">오디션 일정</button>
						<button type="button" class="link" onclick="location.href='artist_list.html'">관심 아티스트</button>
					</nav>
					<!--// Caster GNB -->
				</div>
				<div class="header_actions">
					<button type="button" class="btn btn_search" onclick="location.href='search.html'">검색</button>
					<button type="button" class="btn btn_notification" onclick="location.href='notification.html'">
					</button>
					<button type="button" class="btn btn_profile" onclick="location.href=''">
						<span class="profile_img">
							<img src="../static/images/profile_sample1.jpg" alt="프로필">
						</span>
					</button>
				</div>
			</div>
		</header>
		<main class="bg_white">
			<div class="inner">
				<div class="section_title">
					<h2>심사 하기</h2>
					<!--<div class="desc_group">
						<p class="desc">지원 마감 후, 심사 시작 버튼 클릭후에 심사를 시작할 수 있습니다.</p>
						<button type="button" class="btn_common primary_line">지원 마감</button>
						<button type="button" class="btn_common primary">심사 확정</button>
					</div>-->
					<div class="desc_group">
						<p class="desc primary">심사 확정 상태입니다. 알림이 필요한 심사 결과를 변경할 경우, 지원자에게 즉시 알림이 전송됩니다.</p>
						<button type="button" class="btn_common closed">심사 확정</button>
					</div>
				</div>
				<p class="section_title_desc">나의 심사 내역을 모두 확인 할 수 있습니다.</p>
				<div class="view_top_grid">
					<div class="left">
						<div class="project">
							<div class="top_status">
								<div class="flex_gap10">
									<strong class="d_day soon">D-2</strong>
									<div class="label_group">
										<span class="label_recommend">올캣추천</span>
										<span class="label_urgent">마감임박</span>
										<span class="label_verified">올캣인증</span>
										<span class="label_new">NEW</span>
									</div>
								</div>
							</div>
							<p class="subject">[광고] 판타지 컨셉의 광고 영상</p>
							<div class="detail_row">
								<strong class="tit">단역</strong>
								<p class="desc">남성, 45세, 고루한 아버지역</p>
							</div>
						</div>
					</div>
					<div class="right">
						<div class="project_summary">
							<div class="summary_item">
								<span class="summary_label">리스트업</span>
								<span class="summary_value">2,345명</span>
							</div>
							<div class="summary_item">
								<span class="summary_label">오디션 제안</span>
								<span class="summary_value">
									<span class="label_new">NEW</span>
									<span>123</span>
								</span>
							</div>
							<div class="summary_item">
								<span class="summary_label">캐스팅</span>
								<span class="summary_value">1</span>
							</div>
						</div>
					</div>
				</div>
				<section class="review_view_grid">
					<div class="review_view_left">
						<div class="section_title">
							<h2>심사 대상<span class="cnt">2,345명</span></h2>
							<div class="custom_select min">
								<select>
									<option value="">최근 지원 순</option>
								</select>
							</div>
						</div>
						<p class="section_title_desc">심사를 진행해야하는 지원자입니다.</p>
						<ul class="profile_list">
							<li class="profile_item">
								<div class="profile_img">
									<img src="../static/images/profile_sample2.jpg" alt="">
									<button type="button" class="btn_bookmark active" onclick="toggleActiveClass(this)">bookmark</button>
								</div>
								<div class="profile_info">
									<div class="profile_header">
										<div class="top_status">
											<div class="flex_gap10">
												<h3 class="name">김시현</h3>
												<span class="label_verified">올캣인증</span>
											</div>
										</div>
										<ul class="sub_dot_list min">
											<li>25세</li>
											<li>여성</li>
											<li>국내 전체</li>
										</ul>
									</div>
									<p class="profile_details">165cm / 46kg / 경력 33건 <span class="label_popular">인기</span></p>
									<div class="star_rating">
										<span class="star filled"></span>
										<span class="star filled"></span>
										<span class="star filled"></span>
										<span class="star filled"></span>
										<span class="star"></span>
									</div>
								</div>
							</li>
						</ul>
						<button type="button" class="btn_more_list">더보기</button>
					</div>
					<div class="review_view_right">
						<!-- 리스트업 섹션 -->
						<div class="review_section" data-category="listup">
							<p class="tit">리스트업<span class="cnt">2</span></p>
							<div class="drop_zone">
								<p class="drop_text">여기로 배우 프로필을<br>드래그해서 가져오세요.</p>
							</div>
							<button type="button" class="btn_more">모두 보기</button>
						</div>

						<!-- 오디션제안 섹션 -->
						<div class="review_section" data-category="audition">
							<p class="tit">오디션제안<span class="cnt">2</span></p>
							<div class="drop_zone">
								<p class="drop_text">여기로 배우 프로필을<br>드래그해서 가져오세요.</p>
							</div>
						</div>

						<!-- 캐스팅 섹션 -->
						<div class="review_section casting" data-category="casting">
							<p class="tit">캐스팅<span class="cnt">2</span></p>
							<div class="drop_zone">
								<p class="drop_text">여기로 배우 프로필을<br>드래그해서 가져오세요.</p>
							</div>
						</div>
					</div>
				</section>
			</div>	
		</main>

		<footer class="footer">
			<div class="inner">
				<div class="top">
					<div class="logo"><img src="../static/images/logo.png" alt="ALLCASTING"></div>
					<div class="btns">
						<button type="button" class="ft_pill">아티스트를 찾는다면?</button>
						<button type="button" class="ft_pill">프로젝트를 찾는다면?</button>
						<button type="button" class="ft_sns insta">instagram</button>
						<button type="button" class="ft_sns youtube">instagram</youtube>
					</div>
				</div>
				<div class="legal">
					<p class="row">Copyright © 2025 ALLCASTING. All rights reserved.</p>
					<p class="row">(주)올캣 · 대표자: 홍길동 · 사업자등록번호: 111-22-3333 · 통신판매업 신고번호: 2025-서울강남-01010101</p>
					<p class="row">사업장 소재지: 서울특별시 강남구 여기여기 주소가 들어갑니다.</p>
					<p class="row"><button type="button" class="link">이용약관</button> &middot; <button type="button" class="link">개인정보처리방침</button></p>
				</div>
			</div>
		</footer>
	</div>
	<script>
	// 퍼블 페이지 확인용
	const urlParams = new URL(location.href).searchParams;
	const state = urlParams.get('status');
	if (state === 'none') {
		//document.querySelector('.list_none').style.display = 'block';
		//document.querySelector('.bg_cont_gray').style.display = 'none';
	}
	
	// profile_list 10개 반복 생성
	const profileList = document.querySelector('.profile_list');
	const names = ['김시현', '이민수', '박지영', '최수진', '정현우', '한소영', '윤태호', '강미래', '조성민', '임하늘'];
	const ages = ['25세', '28세', '23세', '30세', '26세', '24세', '29세', '27세', '31세', '22세'];
	const genders = ['여성', '남성', '여성', '여성', '남성', '여성', '남성', '여성', '남성', '여성'];
	const regions = ['국내 전체', '서울', '경기', '부산', '대구', '인천', '광주', '대전', '울산', '세종'];
	const heights = ['165cm', '180cm', '160cm', '168cm', '175cm', '162cm', '182cm', '170cm', '178cm', '158cm'];
	const weights = ['46kg', '75kg', '48kg', '52kg', '70kg', '50kg', '78kg', '55kg', '72kg', '45kg'];
	const experiences = ['33건', '45건', '28건', '52건', '38건', '31건', '48건', '35건', '41건', '25건'];

	for (let i = 0; i < 10; i++) {
		const li = document.createElement('li');
		li.className = 'profile_item drag-source';
		li.innerHTML = `
			<div class="profile_img">
				<img src="../static/images/profile_sample2.jpg"  alt="${names[i]}">
				<button type="button" class="btn_bookmark active" onclick="toggleActiveClass(this)">bookmark</button>
			</div>
			<div class="profile_info">
				<div class="profile_header">
					<div class="top_status">
						<div class="flex_gap10">
							<p class="name">${names[i]}</p>
							<span class="label_verified">올캣인증</span>
						</div>
					</div>
					<ul class="sub_dot_list min">
						<li>${ages[i]}</li>
						<li>${genders[i]}</li>
						<li>${regions[i]}</li>
					</ul>
				</div>
				<p class="profile_details">${heights[i]} / ${weights[i]} / 경력 ${experiences[i]} <span class="label_popular">인기</span></p>
				<div class="star_rating">
					<span class="star filled"></span>
					<span class="star filled"></span>
					<span class="star filled"></span>
					<span class="star filled"></span>
					<span class="star"></span>
				</div>
			</div>
		`;

		profileList.appendChild(li);
	}
	
	// SortableJS를 사용한 드래그 앤 드롭 설정
	setupSortableDragAndDrop();

	// SortableJS 드래그 앤 드롭 기능
	function setupSortableDragAndDrop() {
		// 프로필 리스트를 Sortable로 설정
		const profileList = document.querySelector('.profile_list');
		if (profileList) {
			new Sortable(profileList, {
				group: {
					name: 'profiles',
					pull: 'clone',
					put: false
				},
				draggable: '.drag-source',
				sort: false,
				animation: 150,
				ghostClass: 'sortable-ghost',
				chosenClass: 'sortable-chosen',
				dragClass: 'sortable-drag',
				onStart: function(evt) {
					evt.item.classList.add('dragging');
					// 드래그 중인 요소 정보 저장
					const profileName = evt.item.querySelector('.name').textContent;
					const profileImg = evt.item.querySelector('.profile_img');
					draggedElementInfo = {
						name: profileName,
						img: profileImg ? profileImg.innerHTML : ''
					};
				},
				onEnd: function(evt) {
					evt.item.classList.remove('dragging');
					
					// 드롭 존에 드롭된 경우 profile_item이 남아있다면 제거
					if (evt.to && evt.to.classList.contains('drop_zone')) {
						const profileItems = evt.to.querySelectorAll('.profile_item');
						profileItems.forEach(item => {
							// profile_item이 드롭 존에 남아있다면 제거
							if (item.parentNode === evt.to) {
								item.remove();
							}
						});
					}
				}
			});
		}

		// 각 드롭 존을 Sortable로 설정
		const dropZones = document.querySelectorAll('.drop_zone');
		dropZones.forEach((zone, index) => {
			new Sortable(zone, {
				group: {
					name: 'profiles',
					pull: false,
					put: true
				},
				draggable: '.drag-source',
				sort: false,
				animation: 150,
				ghostClass: 'sortable-ghost',
				chosenClass: 'sortable-chosen',
				dragClass: 'sortable-drag',
				onMove: function(evt) {
					return false;
				},
				// ✅ 실제로 드롭했을 때만 프로필 표시
				onAdd: function(evt) {
					const draggedElement = evt.item;
					const section = evt.to.closest('.review_section');

					const profileName = draggedElement.querySelector('.name').textContent;
					const profileImg = draggedElement.querySelector('.profile_img');

					// 중복 체크
					const existingProfiles = evt.to.querySelectorAll('.dropped_profile');
					const duplicate = Array.from(existingProfiles).some(
						(p) => p.querySelector('.profile_name').textContent === profileName
					);
					if (duplicate) {
						evt.item.remove();
						swalConfirmPopup("이미 추가된 프로필입니다.");
						return;
					}

					// 카운트 갱신
					const countElement = section.querySelector('.cnt');
					if (countElement) {
						countElement.textContent = parseInt(countElement.textContent) + 1;
					}

					// 실제 드롭 프로필 표시
					evt.item.remove();

					const newProfile = document.createElement('div');
						newProfile.className = 'dropped_profile';
						newProfile.innerHTML = `
						<div class="dropped_profile_img">${profileImg.innerHTML}</div>
						<p class="profile_name">${profileName}</p>
						<button type="button" class="remove_btn" onclick="removeProfile(this)">삭제</button>
						`;

						const isCasting = section.classList.contains('casting');
						if (isCasting) {
						const msg = evt.to.querySelector('.casting_message');
						if (msg) evt.to.insertBefore(newProfile, msg);
						else evt.to.appendChild(newProfile);
						} else {
						evt.to.appendChild(newProfile);
					}

					// ✅ 캐스팅 상태 메시지 갱신
					if (isCasting) updateCastingMessage(section);
				}
			});
		});
	}

	// 캐스팅 영역 상태 업데이트 함수
	function updateCastingMessage(section) {
		try {
			const dropZones = section.querySelectorAll('.drop_zone');
			const totalProfiles = Array.from(dropZones).reduce((acc, zone) => {
				return acc + zone.querySelectorAll('.dropped_profile').length;
			}, 0);

			// 문구 영역 찾기 또는 생성
			let message = section.querySelector('.casting_status_message');
			if (totalProfiles > 0) {
				// 프로필이 하나라도 있으면 문구 표시
				if (!message) {
					message = document.createElement('p');
					message.className = 'casting_status_message';
					message.innerHTML = '모든 지원자를<br>캐스팅 콜 하세요.';
					//message.innerHTML = '심사 확정 후,<br>캐스팅 콜이 가능합니다.';
					section.appendChild(message);
				}
				} else {
				// 모두 제거되면 문구도 제거
				if (message) message.remove();
			}
		} catch (e) {
			console.log('캐스팅 상태 업데이트 오류:', e);
		}
	}


	function removeProfile(btn) {
		const profileToRemove = btn.closest('.dropped_profile');
		const dropZone = profileToRemove.closest('.drop_zone');
		const section = dropZone.closest('.review_section');
		const countElement = section.querySelector('.cnt');
		const currentCount = parseInt(countElement.textContent);
		countElement.textContent = currentCount - 1;
		
		// 프로필 제거
		profileToRemove.remove();
		
		// 드롭 존에 프로필이 없으면 기본 텍스트 표시
		const remainingProfiles = dropZone.querySelectorAll('.dropped_profile');
		if (remainingProfiles.length === 0) {
			const isCastingSection = section.classList.contains('casting');
			if (isCastingSection) {
				dropZone.innerHTML = '<p class="drop_text">여기로 배우 프로필을<br>드래그해서 가져오세요.</p>';
			} else {
				dropZone.innerHTML = '<p class="drop_text">여기로 배우 프로필을<br>드래그해서 가져오세요.</p>';
			}
		}

		if (section.classList.contains('casting')) {
  			updateCastingMessage(section);
		}
	}

	// DOM 로드 후 SortableJS 드래그 앤 드롭 설정
	document.addEventListener('DOMContentLoaded', () => {
		// ✅ 기본 드롭 상태 정의 (퍼블 확인용)
		const defaultDropData = {
			normal: [
			{ name: '김시현', img: '../static/images/profile_sample2.jpg' },
			{ name: '이민수', img: '../static/images/profile_sample2.jpg' }
			],
			casting: [
			{ name: '박지영', img: '../static/images/profile_sample2.jpg' },
			{ name: '정현우', img: '../static/images/profile_sample2.jpg' }
			]
		};

		// ✅ 일반 드롭존 기본 프로필 렌더링
		const dropZones = document.querySelectorAll('.review_section:not(.casting) .drop_zone');
		dropZones.forEach(zone => {
			if (defaultDropData.normal && defaultDropData.normal.length > 0) {
			zone.innerHTML = defaultDropData.normal
				.map(profile => `
				<div class="dropped_profile">
					<div class="dropped_profile_img">
					<img src="${profile.img}" alt="${profile.name}">
					</div>
					<p class="profile_name">${profile.name}</p>
					<button type="button" class="remove_btn" onclick="removeProfile(this)">삭제</button>
				</div>
				`)
				.join('');
			} else {
			zone.innerHTML = '<p class="drop_text">여기로 배우 프로필을<br>드래그해서 가져오세요.</p>';
			}
		});

		// ✅ 캐스팅 섹션 기본 프로필 렌더링
		const castingZones = document.querySelectorAll('.review_section.casting .drop_zone');
		castingZones.forEach(zone => {
			if (defaultDropData.casting && defaultDropData.casting.length > 0) {
				zone.innerHTML = defaultDropData.casting
					.map((profile, index) => {
						// 버튼 퍼블 확인용
						const secondButtonClass = (index % 2 === 0) ? 'primary' : 'closed';
						const secondButtonText = (index % 2 === 0) ? '캐스팅콜하기' : '캐스팅콜 완료';

						return `
						<div class="dropped_profile">
							<div class="dropped_profile_img">
								<img src="${profile.img}" alt="${profile.name}">
							</div>
							<p class="profile_name">${profile.name}</p>
							<button type="button" class="remove_btn" onclick="removeProfile(this)">삭제</button>
							<button type="button" class="btn_common ${secondButtonClass}">${secondButtonText}</button>
						</div>
						`;
					})
					.join('') + `
					<!--<p class="casting_message">모든 지원자를<br>캐스팅 콜 하세요.</p>-->
				`;
			} else {
				zone.innerHTML = `
					<p class="drop_text">여기로 배우 프로필을<br>드래그해서 가져오세요.</p>
				`;
			}
		});


		// ✅ 드래그앤드롭 기능 활성화
		setupSortableDragAndDrop();
	});
	</script>
</body>
</html>